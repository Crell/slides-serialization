<!doctype html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

	<title>Serializing PHP</title>

  <link rel="stylesheet" href="dist/reset.css">
  <link rel="stylesheet" href="dist/reveal.css">
  <!--  <link rel="stylesheet" href="dist/theme/black.css" id="theme">-->

  <link rel="stylesheet" href="platform/platformsh.css" id="theme" />

  <!-- Theme used for syntax highlighted code -->
  <link rel="stylesheet" href="plugin/highlight/monokai.css" id="highlight-theme">

  <style>

  </style>

</head>
<body class="skin-blue">
<div class="reveal">
  <footer>
    <img src="assets/typo3-logo.svg" alt="TYPO3" data-credit="https://en.wikipedia.org/wiki/File:Logo_TYPO3.svg" />
    <span class="name">@Crell@phpc.social</span>
  </footer>
	<div class="slides">
    <section class="title">
      <h1>Serializing PHP</h1>
    </section>

    <section id="presenter">
      <h2>Larry Garfield</h2>
      <h2><a href="https://phpc.social/@Crell">@Crell@phpc.social</a></h2>

      <div class="layout-col vcentered">
        <a href="http://bit.ly/php80"><img src="assets/exploring-php80.png" width="175px;" alt="Cover of Exploring PHP 8.0" /></a>
        <a href="https://bit.ly/fn-php"><img src="assets/thinking-functionally.png" width="175px;" alt="Cover of Thinking Functionally in PHP" /></a>

        <ul style="text-wrap: none">
          <li style="margin-top: 1em;">Staff Engineer for <a href="https://www.typo3.com/">LegalZoom</a></li>
          <li style="margin-top: 1em;">PHP-FIG Core Committee</li>
          <li style="margin-top: 1em;">General purpose pedant</li>
          <li style="margin-top: 1em;"><a href="http://bit.ly/php80"><em>Exploring PHP 8.0</em></a></li>
          <li style="margin-top: 1em;"><a href="https://bit.ly/fn-php"><em>Thinking Functionally in PHP</em></a></li>
        </ul>
      </div>
    </section>

    <section>
      <section>
        <h2>What is serialization?</h2>
      </section>
      <section data-background="assets/cereal-bowl.jpg" data-credit="https://flickr.com/photos/cottinghamphotography/6200250080/">
        <h2>Cerealization</h2>
        <p class="fullscreen-credit">(Credit: <a href="https://flickr.com/photos/cottinghamphotography/6200250080/">https://flickr.com/photos/cottinghamphotography/6200250080/</a>)</p>
        <aside class="notes">
          <ul>
            <li>The process of putting cornflakes in milk.</li>
          </ul>
        </aside>
      </section>
      <section>
        <aside class="quote">
          <blockquote>A publication in any medium issued in successive parts
            bearing numerical or chronological designation and intended to be
            continued indefinitely.</blockquote>
          <cite><a href="https://www.dictionary.com/browse/serial">Dictionary.com</a></cite>
        </aside>
        <p class="oversize fragment">"Stuff put in a line"</p>
        <aside class="notes">
          <ul>
            <li>Think serial bus, serial port.</li>
          </ul>
        </aside>
      </section>
      <section>
        <aside class="quote">
          <blockquote>In computing, serialization... is the process of translating a data structure or object
            state into a format that can be <em>stored</em> (e.g. files in secondary storage devices, data buffers in
            primary storage devices) or <em>transmitted</em> (e.g. data streams over computer networks) and
            <em>reconstructed</em> later (possibly in a different computer environment).</blockquote>
          <blockquote class="fragment">For many complex objects, such as those that make extensive use of references,
            this process is <em>not straightforward</em>.</blockquote>
          <cite><a href="https://en.wikipedia.org/wiki/Serializationl">Wikipedia</a></cite>
        </aside>
        <aside class="notes">
          <ul>
            <li>Moving data into and out of the application.</li>
          </ul>
        </aside>
      </section>
    </section>
    <section>
      <section>
        <h2>Plethora of Potential PHP Processes</h2>
        <ul>
          <li class="fragment"><code>__sleep</code>/<code>__wakeup</code> (The before times)</li>
          <li class="fragment"><code>Serializable</code> (PHP 5.1, Deprecated in 8.1)</li>
          <li class="fragment"><code>__serialize</code>/<code>__unserialize</code> (PHP 7.4)</li>
          <li class="fragment"><code>var_export()</code>/<code>__set_state()</code></li>
        </ul>
      </section>
      <!--
      <section>
        <h3><code>__sleep</code>/<code>__wakeup</code> (The before times)</h3>
        <pre><code class="php font--18" data-trim data-noescape data-line-numbers>
          class User {
              protected int $id;
              protected string $name;
              protected DateTime $lastLogin;

              // ...

              public function __sleep() {
                  return ['id', 'name'];
              }

              public function __wakeup() {
                  $this->lastLogin = UserSystem::getLastLogin($this->id);
              }
          }
        </code></pre>
        <pre><code class="php font--18" data-trim data-noescape data-line-numbers>
          $s = serialize(new User());
          print_r($s);

          // O:4:"User":2:{s:5:"*id";i:42;s:7:"*name";s:5:"Larry";}
        </code></pre>
      </section>
      <section>
        <h3><code>__sleep</code>/<code>__wakeup</code></h3>
        <div class="layout-col">
          <div>
            <h3>Done well</h3>
            <ul>
              <li class="fragment">Inheritance works properly</li>
              <li class="fragment">Object references retained</li>
              <li class="fragment">Let's the serializer engine do the hard work</li>
            </ul>
          </div>
          <div>
            <h3 class="fragment">Problems</h3>
            <ul>
              <li class="fragment">Can only serialize existing properties</li>
              <li class="fragment">Cannot control deserialization</li>
            </ul>
          </div>
        </div>
      </section>
      <section>
        <h3><code>Serializable</code> (PHP 5.1)</h3>
        <pre><code class="php font--18" data-trim data-noescape data-line-numbers>
          class User implements Serializable {
              protected int $id;
              protected string $name;
              protected DateTime $lastLogin;

              public function serialize(): string {
                  return serialize(['id' => $this->id, 'name' => $this->name]);
              }

              public function unserialize($serialized): void {
                  $data = unserialize($serialized);
                  $this->id = $data['id'];
                  $this->name = $data['name'];
                  $this->lastLogin = UserSystem::getLastLogin($this->id);
              }
          }
        </code></pre>
        <pre><code class="php font--18" data-trim data-noescape data-line-numbers>
          $s = serialize(new User());
          print_r($s);

          // C:4:"User":43:{a:2:{s:2:"id";i:42;s:4:"name";s:5:"Larry";}}
        </code></pre>
      </section>
      <section>
        <div class="layout-col">
          <div>
            <h3>Done well</h3>
            <ul>
              <li class="fragment">More flexibility in representation</li>
            </ul>
          </div>
          <div>
            <h3 class="fragment">Problems</h3>
            <ul>
              <li class="fragment">Breaks on circular references</li>
              <li class="fragment">Breaks on inheritance (sometimes)</li>
              <li class="fragment">Opaque serialized value</li>
              <li class="fragment">No guarantee serialized format is <code>serialize()</code>-ish</li>
              <li class="fragment">Breaks up the serializer, no optimizations</li>
              <li class="fragment">...Deprecated in 8.1</li>
            </ul>
          </div>
        </div>
      </section>
      -->
      <section>
        <h3><code>__serialize</code>/<code>__unserialize</code> (PHP 7.4)</h3>
        <pre><code class="php font--18" data-trim data-noescape data-line-numbers>
          class User {
              protected int $id;
              protected string $name;
              protected DateTime $lastLogin;

              // ...

              public function __serialize(): array {
                  return ['id' => $this->id, 'name' => $this->name];
              }

              public function __unserialize(array $data): void {
                  $this->id = $data['id'];
                  $this->name = $data['name'];
                  $this->lastLogin = UserSystem::getLastLogin($this->id);
              }
          }
        </code></pre>
        <pre><code class="php font--18" data-trim data-noescape data-line-numbers>
          $s = serialize(new User());
          print_r($s);

          // O:4:"User":2:{s:2:"id";i:42;s:4:"name";s:5:"Larry";}
        </code></pre>
      </section>
      <section>
        <h3><code>__serialize</code>/<code>__unserialize</code></h3>
        <div>
          <h3>Done well</h3>
          <ul>
            <li class="fragment">Inheritance works</li>
            <li class="fragment">Object references retained</li>
            <li class="fragment">Full flexibility for what is serialized</li>
            <li class="fragment">Lets the serializer engine do the hard work</li>
            <li class="fragment">Backward compatible</li>
            <li class="fragment">Identical format to <code>__sleep()</code></li>
            <li class="fragment">Essentially a built-in "normalizer" operation</li>
          </ul>
        </div>
        <div>
          <h3 class="fragment">Problems</h3>
          <ul>
            <li class="fragment">Serialized format is PHP-only, not human-editable.</li>
          </ul>
        </div>
        <aside class="notes">
          <ul>
            <li>BC because methods ignored on older PHP versions</li>
          </ul>
        </aside>
      </section>
      <section>
        <h3><code>var_export()</code>/<code>__set_state()</code> (PHP 4.2)</h3>
        <pre><code class="php font--16" data-trim data-noescape data-line-numbers>
          class User {
              protected int $id;
              protected string $name;
              protected DateTime $lastLogin;

              public static function __set_state(array $data): self {
                  $new = new self();
                  $new->id = $data['id'];
                  $new->name = $data['name'];
                  $new->lastLogin = UserSystem::getLastLogin($this->id);
                  return $new;
              }
          }
        </code></pre>
        <pre><code class="php font--16" data-trim data-noescape data-line-numbers>
          $s = var_export(new User(), true);
          file_put_contents('export.php', "&lt;?php return $s;");

          $u = require('export.php');
        </code></pre>
        <pre class="fragment"><code class="php font--16" data-trim data-noescape data-line-numbers>
          &lt;?php return User::__set_state(array(
             'id' => 5,
             'name' => 'Crell',
             'lastLogin' =>
            DateTime::__set_state(array(
               'date' => '2023-08-22 21:26:52.441708',
               'timezone_type' => 3,
               'timezone' => 'Europe/Amsterdam',
            )),
          ))
        </code></pre>
      </section>
      <section>
        <h3><code>var_export()</code>/<code>__set_state()</code></h3>
        <div class="layout-col">
          <div>
            <h3>Done well</h3>
            <ul>
              <li class="fragment">Produces executable code</li>
              <li class="fragment">Works for all variable types</li>
              <li class="fragment">Opcache-friendly (for non-objects)</li>
              <li class="fragment">Great for compiled lookkup table arrays.</li>
            </ul>
          </div>
          <div>
            <h3 class="fragment">Problems</h3>
            <ul>
              <li class="fragment">Can only control the deserialization side</li>
              <li class="fragment">Deserialization requires custom user-space code</li>
              <li class="fragment">Objects are all opt-in (need <code>__set_state()</code>)</li>
            </ul>
          </div>
        </div>
      </section>
    </section>
    <section>
      <section>
        <h2>Which is better?</h2>
        <p class="fragment oversize">Quick, to the benchmark mobile!</p>
        <aside class="notes">
          <ul>
            <li>Expected var_export() to be fastest, if more work.</li>
            <li>Trust, but verify!</li>
          </ul>
        </aside>
      </section>
      <section>
        <h2>Test setup</h2>
        <ul>
          <li class="fragment">Comparing <code>serialize()</code> to <code>var_export()</code></li>
          <li class="fragment">Object with 4 properties: Leaf, sequential list, associative list, recursive object</li>
          <li class="fragment">Scale list size to 20,000.  Scale recursion level to 500</li>
        </ul>
        <div class="fragment">
          <h2>Predictions</h2>
          <ul>
            <li class="fragment"><code>require()</code>ing > <code>unserialize()</code></li>
            <li class="fragment">Custom <code>__unserialize()</code> will be slower</li>
          </ul>
        </div>
        <aside class="notes">
          <ul>
            <li>Unclear memory issues above 500 recursion</li>
            <li>Opcache should make require() fast</li>
          </ul>
        </aside>
      </section>
      <section>
        <h2>The results</h2>
        <p><img src="assets/strange-planet-science.png" style="height: 600px" alt="I produced a detailed tribute to my wrongness.  That is science." /></p>
        <p><cite>&mdash;<a href="https://www.nathanwpyle.art/">Nathan Pyle</a></cite></p>
        <p>cf: <a href="https://peakd.com/hive-168588/@crell/benchmarking-serialization">Benchmarking Serialization</a></p>
      </section>
      <section>
        <h2>CLI Tests</h2>
        <p><img src="assets/benchmark-results-cli.png" alt="Results showing require() being vastly slower than anything else"></p>
        <p class="fragment">No Opcache in CLI!</p>
        <aside class="notes">
          <ul>
            <li>Duh, no opcache</li>
            <li>var_export() is slower than serialize()</li>
            <li>A custom __unserialize() function makes it... faster???</li>
          </ul>
        </aside>
      </section>
      <section>
        <h2>Apache Bench tests</h2>
        <p><img src="assets/benchmark-results-web-concurrency-1.png" alt="require() has a big jump in runtime around 4500 entries"></p>
        <p class="fragment">Opcache max file size!</p>
        <aside class="notes">
          <ul>
            <li>Why does the runtime go... down?</li>
            <li>What is unserialize() doing ~7000 objects?</li>
            <li>I have no idea...</li>
          </ul>
        </aside>
      </section>
      <section>
        <h2>Zoom in on the left</h2>
        <p><img src="assets/benchmark-results-web-zoomed.png" alt="var_export() is faster at low cardinality"></p>
        <p class="fragment"><code>var_export()</code> wins! ...By 1.25 ms over 4000 objects</p>
      </section>
      <section>
        <h2>Conclusions</h2>
        <p><code>var_export()</code> is faster than <code>require()</code>
          <div class="fragment">by a very slim margin</div>
          <div class="fragment">under very specific conditions</div>
          <div class="fragment">and requires a lot more work.</div>
        </p>
        <br />
        <p class="fragment">Exporting objects to code is almost never worth it. <code>unserialize()</code> is very fast.</p>
        <aside class="notes">
          <ul>
            <li>1.25 ms over 4000 objects</li>
            <li>Beware of opcache size</li>
            <li>Lots of extra work for very little gain</li>
            <li>var_export() still OK for arrays, just not objects</li>
          </ul>
        </aside>
      </section>
    </section>
    <section>
      <section>
        <h2>But what about outside systems?</h2>
      </section>
      <section>
        <h2>What should you serialize?</h2>
      </section>
      <section>
        <h2>Separate Logic from Data</h2>
        <div>
          <div style="float: left;"><img src="assets/spock.jpg" alt="Logic" style="max-height: 400px;" /></div>
          <div style="float: right;"><img src="assets/data.jpg" alt="Data"  style="max-height: 400px;" /></div>
        </div>
      </section>
      <section>
        <h2>Separate logic from data</h2>
        <ul>
          <li class="fragment">If it's in your DI Container, thou shalt not serialize it</li>
          <li class="fragment">If it references something in the container, thou shalt not serialize</li>
          <li class="fragment">Value objects: +1</li>
          <li class="fragment">Entities: Only in data mapper</li>
          <li class="fragment">Just say <em>No</em> to Active Record</li>
          <li class="fragment">Applies to all serialization formats</li>
        </ul>
        <aside class="notes">
          <ul>
            <li>All alternatives suck, involve globals</li>
            <li>Applies to serialize()/var_export(), too.</li>
          </ul>
        </aside>
      </section>
    </section>
    <section>
      <section>
        <h2>Story time</h2>
        <p><img src="assets/typo3.svg" alt="TYPO3" style="width: 400px"></p>
        <aside class="notes">
          <ul>
            <li>In 2021, worked at TYPO3</li>
            <li>Turn massive config array into objects</li>
            <li>20+ year old config structure, never refactored for BC reasons</li>
            <li>Needed to change structure on import</li>
          </ul>
        </aside>
      </section>
      <section>
        <h2>Requirements</h2>
        <ul>
          <li class="fragment">Mutate data on import</li>
          <li class="fragment">Dynamic type maps</li>
          <li class="fragment">Implode/explode arrays, sometimes</li>
          <li class="fragment">Fast</li>
        </ul>
        <p class="fragment"><q>Don't solve a problem, build a tool to solve the problem, then use it.</q></p>
        <aside class="notes">
          <ul>
            <li>Type maps = Nested object that could be different types</li>
            <li>Sounds like a special case of serialization!</li>
          </ul>
        </aside>
      </section>
      <section>
        <h2>So, Symfony Serializer?</h2>
        <ul>
          <li class="fragment" style="list-style-type: '+'">Widely used</li>
          <li class="fragment" style="list-style-type: '+'">Very flexible</li>
          <li class="fragment" style="list-style-type: '-'">Couldn't collect/flatten</li>
          <li class="fragment" style="list-style-type: '-'">Only static type maps ("class discriminators")</li>
          <li class="fragment" style="list-style-type: '-'">Complex architecture, hard to modify</li>
        </ul>
        <p class="fragment">Sigh.  Time to write one...</p>
        <aside class="notes">
          <ul>
            <li>2 weeks trying to make it work</li>
            <li>Became clear it couldn't do what I wanted</li>
          </ul>
        </aside>
      </section>
    </section>
    <section>
      <section>
        <h2>Simple hydration</h2>
        <h2 class="fragment"><a href="https://github.com/Crell/EnvMapper">EnvMapper</a></h2>
      </section>
      <section>
        <h2>The core logic (1)</h2>
         <pre><code class="php font--16" data-trim data-noescape data-line-numbers>
          class EnvMapper {
              public function map(string $class, bool $require = false, ?array $source = null): object {
                  $source ??= $_ENV;
                  $rClass = new \ReflectionClass($class);
                  $rProperties = $rClass->getProperties();

                  $toSet = [];
                  foreach ($rProperties as $rProp) {
                      $propName = $rProp->getName();
                      $envName = $this->normalizeName($propName);
                      if (isset($source[$envName])) {
                          $toSet[$propName]
                            = $this->typeNormalize($source[$envName], $rProp);
                      } elseif (ParamValue::None !== $default = $this->getDefaultValue($rProp)) {
                          $toSet[$propName] = $default;
                      } elseif ($require) {
                          throw MissingEnvValue::create($propName, $class);
                      }
                  }

                  // ...
              }
           }
        </code></pre>
      </section>
      <section>
        <h2>The core logic (2)</h2>
         <pre><code class="php font--16" data-trim data-noescape data-line-numbers>
          class EnvMapper {
              public function map(string $class, bool $require = false, ?array $source = null): object {
                  // ...

                  $populator = function (array $props) {
                      foreach ($props as $k => $v) {
                          try {
                              $this->$k = $v;
                          } catch (\TypeError $e) {
                              throw TypeMismatch::create($this::class, $k, $v);
                          }
                      }
                  };

                  $env = $rClass->newInstanceWithoutConstructor();

                  $populator->call($env, $toSet);

                  return $env;
              }
           }
        </code></pre>
      </section>
      <section>
        <h2>What does this show?</h2>
        <ul>
          <li class="fragment">Deserialization is driven by class definition</li>
          <li class="fragment">Type info & defaults driven by class definition</li>
          <li class="fragment">Reflection is surprisingly fast</li>
          <li class="fragment">Enums as error codes!</li>
          <li class="fragment">Busting scope is easy <span class="fragment">(please don't)</span></li>
        </ul>
        <p class="fragment oversize">These will be important</p>
      </section>
    </section>

    <div style="display: none">
      * What is serialization?
        * Putting cornflakes in milk.  (Photo)
        * Definition: make a sequence, in a line.
        * Definition from Wikipedia.
      * Plethora of potential PHP processes
      * Built-ins
        * Mention old stuff, Serializable and __wakeup()
        * __serialize/__unserialize
        * var_export()
        * Benchmarks
        * Conclusion: If you want internal-only serialization, serialize() still wins.
      * What should you serialize?
        * Data objects
        * No service objects
        * Data objects with service object dependency are not data objects.
          * All the ways around this problem suck/involve globals.
      * Custom serialization
        * At TYPO3, fall 2021, wanted to turn massive config arrays into class readonly objects.
        * "Don't solve a problem, build a tool to solve the problem, then use it."
        * Needed flatten/collect, dynamic type map, high performance.
        * Tried Symfony Serializer...  way too convoluted, didn't have flatten/collect or dynamic type map.
        * Time to write one...
      * A trivial deserializer - EnvMapper
      * Crell/Serde - 8.1 before it was even out
        * Entirely attribute driven
        * AttributeUtils
        * Crell/fp - FP tools, used extensively.
        * Goal is to showcase what goes into serialization, and the power of PHP 8.1.
          * Not just showing off.
      * Deep dive - Attribute Utils
        * Incorporate reflection
        * Interface-driven functionality
        * Class-at-a-time
        * Include/exclude/Excludable
        * Inheritance!  Including interfaces!
        * Sub-attributes
        * Cache-friendly
        * Multi-step construction - SA tools, you're wrong about readonly.
        * Scopes (for serialization groups)
      * Deep dive - Serde
        * Constructor default value objects.
        * $propReader/$propWriter, to bypass visibility.
        * Enum as default object instances (renaming)
        * Recursive walk, to support streaming formats
        * Enum error codes
        * Sequence vs Dict
          * Implode
        * Iterables
          * Include example of DB->JSON streaming.
        * TypeMaps
        * Flatten/collect
        * Scopes
      * Notice... everything is immutable. Everything.  It can be done.
      * Showcase: Crell/Config.  What I wanted to build in the first place.
      * TYPO3... ended up not using it.  But yay Free Software, you can!
      * Recap
        * If it's just for internal use, serialize() still wins.
        * Separate data and logic
        * Attributes are frickin' awesome, especially with an improved parser (AttributeUtils)
        * PHP 8.x rocks.
        * It's helpful to periodically burn it down and start over... in small pieces.  (Component design!)
        * For the most robust serialization/deserialization, use Serde.
        * For the most easy to use ser/de, use Serde.
        * Hooray Free Software!


    </div>

    <section id="final">
      <div class="layout-1up-2down">
        <div style="grid-area: top; margin-top: 1em;">
          <h2>Larry Garfield</h2>
          <h2><a href="https://phpc.social/@Crell">@Crell@phpc.social</a></h2>
        </div>
        <div style="grid-area: left">
          <h2>All about PHP 8!</h2>
          <p><a href="https://bit.ly/php80">https://bit.ly/php80</a></p>
          <p><a href="https://bit.ly/php80"><img src="assets/exploring-php80.png" width="175px;" alt="Cover of Exploring PHP 8.0" /></a></p>
        </div>
        <div style="grid-area: right">
          <h2>Buy my book!</h2>
          <p><a href="https://bit.ly/fn-php">https://bit.ly/fn-php</a></p>
          <p><a href="https://bit.ly/fn-php"><img src="assets/thinking-functionally.png" width="175px;" alt="Cover of Thinking Functionally in PHP" /></a></p>
        </div>
      </div>
      <h3><a href="https://www.garfieldtech.com/">https://www.garfieldtech.com/</a></h3>
    </section>
  </div>
</div>

<script src="dist/reveal.js"></script>
<script src="plugin/notes/notes.js"></script>
<script src="plugin/markdown/markdown.js"></script>
<script src="plugin/highlight/highlight.js"></script>
<script>
  // More info about initialization & config:
  // - https://revealjs.com/initialization/
  // - https://revealjs.com/config/
  Reveal.initialize({
    hash: true,

    // Learn about plugins: https://revealjs.com/plugins/
    plugins: [ RevealMarkdown, RevealHighlight, RevealNotes ]
  });
</script>

<!-- Custom Reveal extension scripts. -->
<script src="platform/classer.js"></script>
<script src="platform/countup.js"></script>
<script src="platform/usecase.js"></script>

</body>
</html>
